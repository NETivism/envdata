<?php
error_reporting(E_ALL);
ini_set('display_errors', TRUE);
ini_set('display_startup_errors', TRUE);

function envdata_init(){
  envdata_add_resource('chartist');
}

function envdata_cron(){
  module_load_include('inc', 'envdata', 'envdata.airq');
  envdata_airq_update_gov_file();
  envdata_airq_create_geojson();
}

function envdata_menu() {
  $items['envdata/chart/image/%'] = array(
    'title' => 'save chart svg to image',
    'page callback' => 'envdata_chart_image',
    'page arguments' => array(3),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'envdata.chart.inc',
  );
  $items['envdata/chart/svg/%'] = array(
    'title' => 'render svg to html',
    'page callback' => 'envdata_chart_svg',
    'page arguments' => array(3),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'envdata.chart.inc',
  );

  return $items;
}

function envdata_block_info() {
  $block['facility_realtime_charts'] = array(
    'info' => 'envdata: facility realtime charts',
    'cache' => DRUPAL_NO_CACHE,
  );

  return $block;
}

function envdata_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'facility_realtime_charts':
      module_load_include('inc', 'envdata', 'envdata.chart');
      if(arg(0) == 'facility' && arg(1)){
        $vars = array(
          'registration_no' => arg(1),
        );
        $block['content'] = envdata_prepare_chart($vars);
      }
      break;
  }

  return $block;
}


function envdata_add_resource($type = 'all'){
  $module_envdata   = drupal_get_path('module', 'envdata');

  if($type == 'chartist' || $type == 'all') {
    // chartist
    drupal_add_css($module_envdata . '/vendor/chartist/chartist.min.css');
    drupal_add_js($module_envdata . '/vendor/chartist/chartist.min.js');
    drupal_add_js($module_envdata . '/vendor/chartist-plugin-threshold/chartist-plugin-threshold.js');
    drupal_add_js($module_envdata . '/vendor/chartist-plugin-axistitle/chartist-plugin-axistitle.min.js');
  }
  
  // papaparse
  if($type == 'papaparse' || $type == 'all') {
    drupal_add_js($module_envdata . '/vendor/papaparse/papaparse.min.js');
  }

  // jquery-modal
  if($type == 'jquery-modal' || $type == 'all') {
    drupal_add_css($module_envdata . '/vendor/jquery-modal/jquery.modal.css');
    drupal_add_js($module_envdata . '/vendor/jquery-modal/jquery.modal.min.js');
  }

  // tabslet
  if($type == 'tabslet' || $type == 'all') {
    drupal_add_js($module_envdata . '/vendor/tabslet/jquery.tabslet.min.js');
  }

  // module custom
  if($type == 'envdata' || $type == 'all') {
    drupal_add_css($module_envdata . '/css/envdata-facility-charts.css');
    drupal_add_js($module_envdata . '/js/fbjs-init.js');
    drupal_add_js($module_envdata . '/js/envdata-facility-charts.js');
  }
}
